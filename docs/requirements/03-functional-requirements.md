# 4. 機能要件

## 4.1 機密情報管理

### FR-1.1 機密情報の保存
- **要件**: ユーザーが機密情報をキーと値のペアで保存できること
- **アクター**: ユーザー
- **前提条件**: 有効なトークンが存在する
- **入力**:
  - キー (必須)
  - 値 (必須)
  - 有効期限 (オプション)
- **成功条件**: 機密情報が安全に保存され、以下のメタデータが記録される
  - 作成日時
  - 作成者 (ユーザー ID)
  - 有効期限 (指定された場合)
  - 最終更新日時
  - 最終更新者
  - 最終アクセス日時
- **失敗条件**:
  - トークンが無効または期限切れ
  - 同じユーザーで同じキーが既に存在する

### FR-1.2 機密情報の取得
- **要件**: 有効なトークンを持つユーザーが自分の機密情報を取得できること
- **アクター**: ユーザー、アプリケーション
- **前提条件**: 有効なアクセストークンが存在する
- **成功条件**: 指定されたキーの機密情報が返され、最終アクセス日時が更新される
- **失敗条件**:
  - トークンが無効または期限切れ
  - キーが存在しない（自分が作成したキーの中に存在しない）
  - トークンが無効化されている
  - 機密情報の有効期限が切れている
- **備考**: 他のユーザーが作成した機密情報には一切アクセスできない

### FR-1.3 機密情報の更新
- **要件**: ユーザーが自分の既存の機密情報を更新できること
- **アクター**: ユーザー
- **前提条件**:
  - 有効なトークンが存在する
  - 更新対象のキーが存在する（自分が作成したキー）
- **入力**:
  - キー (必須)
  - 値 (必須)
  - 有効期限 (オプション)
- **成功条件**: 機密情報が更新され、以下のメタデータが更新される
  - 最終更新日時
  - 最終更新者 (ユーザー ID)
  - 有効期限 (指定された場合)

### FR-1.4 機密情報の削除
- **要件**: ユーザーが自分の機密情報を削除できること
- **アクター**: ユーザー
- **前提条件**:
  - 有効なトークンが存在する
  - 削除対象のキーが存在する（自分が作成したキー）
- **成功条件**: 機密情報が完全に削除される

### FR-1.5 機密情報のキー一覧取得
- **要件**: ユーザーが自分が保存した機密情報のキー一覧を取得できること
- **アクター**: ユーザー
- **前提条件**: 有効なアクセストークンが存在する
- **成功条件**: 自分の機密情報のキーリストが返される (値は含まない)
- **オプション**: パターンマッチによるフィルタリング
- **備考**: 他のユーザーの機密情報は一覧に表示されない

### FR-1.6 有効期限管理
- **要件**: ユーザーが自分の機密情報の有効期限を管理できること
- **アクター**: ユーザー
- **機能**:
  - 有効期限切れ間近 (例: 7 日以内) の自分の機密情報を一覧表示
  - 有効期限切れの自分の機密情報を一覧表示
  - 有効期限切れの自分の機密情報を削除するコマンド
- **前提条件**: 有効なアクセストークンが存在する
- **成功条件**: 指定された条件に合致する自分の機密情報の一覧が返される

## 4.2 ユーザー認証

### FR-2.1 ユーザー登録
- **要件**: 新規ユーザーが Passkey を使って登録できること
- **アクター**: 新規ユーザー
- **入力**: ユーザー ID、ユーザー名
- **成功条件**:
  - ユーザーアカウントが作成される
  - Passkey 認証情報が1つ登録される (1 ユーザー = 1 Passkey)
  - 作成日時が記録される
- **失敗条件**:
  - ユーザー ID またはユーザー名が既に存在する
  - Passkey 作成に失敗
- **備考**:
  - Phase 1 では 1 ユーザーにつき 1 つの Passkey のみ登録可能
  - ユーザー登録は誰でも自由に実行可能（セルフ登録）

### FR-2.2 ユーザー認証
- **要件**: 登録済みユーザーが Passkey を使って認証できること
- **アクター**: 登録済みユーザー
- **入力**: ユーザー ID
- **認証 UX**:
  - **デフォルト**: ブラウザ自動起動
    - CLI がブラウザを自動的に開く
    - ブラウザで Passkey 認証を実行
    - 認証成功後、ブラウザを閉じて CLI に戻る
  - **WSL などブラウザ自動起動できない環境**: 手動コピー方式
    - CLI が認証 URL を表示
    - ユーザーが手動でブラウザを開いて URL にアクセス
    - Passkey 認証後、ブラウザにトークンが表示される
    - ユーザーがトークンをコピーして CLI に貼り付け
    - CLI が処理を続行
- **成功条件**:
  - 認証が成功する
  - アクセストークンが発行される
  - ログイン日時が記録される
- **失敗条件**:
  - ユーザーが存在しない
  - Passkey 認証に失敗
- **備考**: Claude Code と同様の認証 UX を提供

## 4.3 トークン管理

### FR-3.1 トークン発行
- **要件**: 認証成功後、時間制限付きアクセストークンが発行されること
- **前提条件**: Passkey 認証が成功している
- **入力**:
  - ユーザー ID
  - 有効期限 (時間単位、デフォルト: 1 時間)
- **成功条件**:
  - アクセストークンが生成される
  - トークン情報がデータベースに記録される
  - 有効期限が設定される
- **制約**:
  - 1 ユーザーあたりのトークン数制限 (設定可能、デフォルト: 5個)
  - 制限を超える場合、最も古いトークンが自動的に無効化される
- **備考**:
  - トークンはユーザー識別のためのものであり、機密情報の値の読み取り専用アクセスを提供する
  - トークン自体は権限を決定せず、トークンに紐づくユーザーが作成した機密情報のみにアクセス可能
  - Phase 1 ではトークンのスコープ設定は不要
  - リフレッシュトークン機能は Phase 1 では不要 (将来的な拡張候補)

### FR-3.2 トークン検証
- **要件**: API リクエスト時にトークンの有効性が検証されること
- **検証項目**:
  - トークンが存在する
  - 有効期限内である
  - 無効化されていない
- **成功条件**: トークンが有効である
- **失敗条件**: 上記のいずれかの条件を満たさない

### FR-3.3 トークン無効化
- **要件**: ユーザーが自分のトークンを無効化できること
- **アクター**: 管理者、一般ユーザー
- **ユースケース**:
  - ログアウト
  - セキュリティ侵害時の緊急対応
- **成功条件**: トークンが即座に無効化される

### FR-3.4 トークン一覧取得
- **要件**: ユーザーが自分の有効なトークン一覧を確認できること
- **アクター**: 管理者、一般ユーザー
- **成功条件**: 自分に紐づく有効なトークンの情報 (ハッシュ、作成日時、有効期限) が返される

## 4.4 監査とログ

### FR-4.1 アクセスログの記録
- **要件**: すべての機密情報へのアクセスが記録されること
- **記録内容**:
  - 誰が (ユーザー ID)
  - いつ (タイムスタンプ)
  - 何を (アクション: get/store/update/delete)
  - どのリソースに (キー)
  - 成功/失敗
  - 失敗時のエラーメッセージ
- **保持期間**: 推奨 90 日間以上（自動削除・アーカイブ・容量制限機能は提供しない）
- **備考**:
  - すべてのユーザーの操作を共通のログファイルに出力
  - ログ管理（削除・アーカイブ・容量制限）はユーザー側で実施

### FR-4.2 監査ログの検索
- **要件**: ユーザーが監査ログを検索・閲覧できること
- **アクター**: ユーザー
- **検索条件**: ユーザー ID、日時範囲、アクション種別、リソースキー
- **備考**: Phase 3 で実装予定

## 4.5 ライブラリインターフェース

### FR-5.1 ライブラリとしての提供
- **要件**: プログラムから VaultKey を利用できること
- **提供 API**:
  - クライアントクラスのインスタンス化
  - `getSecret(key, token)`: 機密情報取得
  - `storeSecret(key, value, token, expiresAt?)`: 機密情報保存 (有効期限オプション)
  - `updateSecret(key, value, token, expiresAt?)`: 機密情報更新 (有効期限オプション)
  - `deleteSecret(key, token)`: 機密情報削除
  - `listSecrets(token, pattern?)`: キー一覧取得
  - `listExpiringSecrets(token, daysUntilExpiry)`: 有効期限切れ間近の機密情報一覧
  - `listExpiredSecrets(token)`: 有効期限切れの機密情報一覧
  - `deleteExpiredSecrets(token)`: 有効期限切れの機密情報削除
  - `revokeToken(token)`: トークン無効化
  - `listTokens(token)`: トークン一覧取得

### FR-5.2 エラーハンドリング
- **要件**: すべてのエラーを適切な形式で通知すること
- **エラー種別**:
  - 認証エラー
  - 権限エラー
  - リソース未検出
  - バリデーションエラー
  - リソース競合
  - その他のエラー

## 4.6 CLI インターフェース

### FR-6.1 CLI としての提供
- **要件**: コマンドラインから VaultKey を操作できること
- **提供コマンド**:
  - `init`: データベース初期化
  - `user register`: ユーザー登録
  - `user login`: ユーザー認証・トークン発行
  - `secret get <key>`: 機密情報取得
  - `secret set <key> [--expires-in <duration>]`: 機密情報保存（値は対話的に入力、有効期限オプション）
  - `secret update <key> [--expires-in <duration>]`: 機密情報更新（値は対話的に入力、有効期限オプション）
  - `secret delete <key> [--force]`: 機密情報削除（確認ダイアログあり、`--force` で確認スキップ）
  - `secret list [--pattern <pattern>]`: キー一覧取得
  - `secret list-expiring [--days <days>]`: 有効期限切れ間近の機密情報一覧
  - `secret list-expired`: 有効期限切れの機密情報一覧
  - `secret cleanup-expired [--force]`: 有効期限切れの機密情報削除（確認ダイアログあり）
  - `token revoke <token>`: トークン無効化
  - `token list`: トークン一覧取得
  - `audit search`: 監査ログ検索

### FR-6.2 トークンの扱い
- **要件**: CLI でトークンを安全に扱えること
- **方式**:
  - トークンは環境変数から読み込み
  - または `--token` オプションで指定
  - トークンファイルからの読み込みも可能

### FR-6.3 出力フォーマット
- **要件**: CLI の出力フォーマットを選択できること
- **フォーマット**:
  - `--format json`: JSON 形式
  - `--format yaml`: YAML 形式
  - デフォルト: 人間が読みやすいテーブル形式

### FR-6.4 対話的入力
- **要件**: 機密情報の値を対話的に入力できること
- **方式**:
  - `secret set` および `secret update` コマンドでは値を引数で指定しない
  - コマンド実行後、対話的にパスワード入力プロンプトが表示される
  - 入力された値はマスク表示され、コマンド履歴に残らない
- **例**:
  ```bash
  vaultkey secret set api_key
  Enter value: ********  # ユーザーが入力（マスク表示）
  ```

### FR-6.5 確認ダイアログ
- **要件**: 危険な操作には確認ダイアログを表示すること
- **対象操作**:
  - `secret delete`: 機密情報の削除
  - `secret cleanup-expired`: 有効期限切れ機密情報の一括削除
- **方式**:
  - デフォルトで確認ダイアログを表示
  - `--force` オプションで確認をスキップ可能
- **例**:
  ```bash
  vaultkey secret delete api_key
  Are you sure you want to delete 'api_key'? (y/N):
  ```
